<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Quicksand">

<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<!-- jQuery library -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!-- Latest compiled JavaScript -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<link rel="stylesheet"
	href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script
	src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/vendor.css">
<script
	src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/vendor.js"></script>

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.css">
<script
	src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.js"></script>
<script
	src='https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.js.map'></script>

<script
	src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.min.js"></script>

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script src="https://unpkg.com/konva@4.0.0/konva.min.js"></script>

<link rel="stylesheet" href="css/mapEdit.css">
<script src="js/util/crop.js"></script>

<title>Map Edit</title>

<style type="text/css">
body {
	background-color: #f2f2f2;
}

.topnav {
	background-color: #C1FF94;
	overflow: hidden;
}

#home {
	float: left;
	color: #58BD0F;
	padding-left: 75px;
	font-size: 30px;
}

#logout {
	float: right;
	color: #58BD0F;
	padding-right: 75px;
	text-decoration: none;
	font-size: 30px;
}

#back {
	color: #58BD0F;
	padding-left: 30px;
	font-size: 30px;
}

#title1 {
	color: rgb(189, 194, 161);
	padding-top: 30px;
}

.icon {
	font-size: 25px;
	color: green;
}

#input {
	width: 60px;
}

.btn-circle.btn-xl {
	width: 70px;
	height: 70px;
	padding: 10px 16px;
	border-radius: 35px;
	font-size: 12px;
	text-align: center;
}

nav ul {
	height: 200px;
	width: 90%;
}

nav ul {
	overflow: hidden;
	overflow-y: scroll;
}
</style>
</head>
<body style="font-family: 'Quicksand'">
	<div class="topnav">
		<a id="home" href="list.html"><i class="glyphicon glyphicon-home"></i></a>
		<a id="logout" href="login.html">Logout</a>
	</div>
	<div class="card">
		<div class="row">
			<h1 id="title1">&emsp;&emsp;Map Name</h1>
			<div class="col-9"
				style="display: flex; justify-content: flex-end; padding-bottom: 10px">
				<a href="list.html"></a>
				<button type="button"
					class="myButton btn btn-success btn-circle btn-xl align-self-end"
					id="myBtn">Save</button>
				</a>
			</div>
		</div>
	</div>

	<div class= "container">
	<div class="row">
		<div style="padding-left: 75px;" class="col-sm-3">
			<div class="shadow-lg p-3 mb-5 bg-white rounded">
				<h3>Available Items</h3>
				<br> <input type="text" placeholder="Search.."><br>
				<br>
				<br>
				<nav>
					<ul id = "itemlist">
					</ul>
				</nav>
			</div>
		</div>
		<div class="col-sm-6">

			<div id="mapContainer">
				<div id="mapid"></div>
			</div>

<!--			<button type="button" onclick="callEnterFreeHand()">Free-->
<!--				Hand Drawing Control</button>-->
			<button type="button" onclick="getGeoJSON()">getGeoJSON</button>

<!--			<div>-->
<!--				<div id="search-container">-->
<!--					<input type="text" id="materialsSearch" onkeyup="filterOn()"-->
<!--						placeholder="Search for resource...">-->
<!--				</div>-->
<!--				<div id="materialsContainer"></div>-->
<!--			</div>-->
		</div>
		<div style="padding-right: 75px;" class="col-sm-3">
			<div class="shadow-lg p-3 mb-5 bg-white rounded">
				<h3>Your added items</h3>
				<br>
				<nav>
					<ul id = "itemlist2" style="font-size: 18px;">
						<li>Fences : 500</li>
						<li>Benches : 45</li>
						<li>Tennis balls : 100</li>
						<li>Fences : 500</li>
						<li>Benches : 45</li>
						<li>Tennis balls : 100</li>
						<li>Fences : 500</li>
						<li>Benches : 45</li>
						<li>Tennis balls : 100</li>
					</ul>
				</nav>
			</div>
		</div>
	</div>
</body>

<script>
	//inits the map and properties.
	let map = L.map('mapid', {
		center : [ 52.2413, -353.1531 ],
		zoom : 16,
		keyboard : false
	});

	let tiles = L.tileLayer(
					'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
					{
						maxZoom : 19,
						attribution : '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
					});
	tiles.addTo(map);

	var printer = L.easyPrint({
		tileLayer : tiles,
		sizeModes : [ 'Current', 'A4Landscape', 'A4Portrait' ],
		filename : 'myMap',
		exportOnly : true,
		hideControlContainer : true
	}).addTo(map);

	let editToggle = L.easyButton({
		id : 'edit-mode-toggle',
		states : [ {
			stateName : 'disable-editing',
			icon : 'fa-edit',
			title : 'Disable Editing',
			onClick : function(control) {
				imgGroup.forEach(function(img) {
					img.editing.disable();
				});
				control.state('enable-editing');
			}
		}, {
			stateName : 'enable-editing',
			icon : 'fa-window-close',
			title : 'Enable Editing',
			onClick : function(control) {
				imgGroup.forEach(function(img) {
					img.editing.enable();
				});
				control.state('disable-editing');
			}
		} ]
	});
	editToggle.addTo(map);

	//the array in which all the images added are stored
	let imgGroup = [];
	let resourceArray = [];
	//boolean to check weather free hand drawing is being done.
	let inFreeHand = false;

	let materialsList = null;

	let objReq = new XMLHttpRequest();
	objReq.onreadystatechange = function() {
		if (this.readyState === 4 && this.status === 200) {
			materialsList = JSON.parse(objReq.responseText);
			console.log(materialsList);
			itemlist = document.getElementById("itemlist");
			var htmltext = ""
//				<label><li>Item 1 :</li></label>
//				<input id="input" type="number" name="quantity">
//				<button style="background-color: #58BD0F; border-color: #C1FF94">+</button>
//				<br>
//				<br>
			for (let i = 0; i < materialsList.length; i++) {
				htmltext += "<label><li>Item " + materialsList[i].resourceId + ":</li></label> ";
				htmltext += "<input id ='input" + materialsList[i].resourceId + "' type = 'number' name = 'quantity'> "
				htmltext += "<button onclick ='addItem2(" + materialsList[i].resourceId + ")' style='background-color: #58BD0F; border-color: #C1FF94'>+</button> "
				htmltext += "<br><br>";
				
			}
			itemlist.innerHTML = htmltext;
		} else {
			console.log("failure")
		}
	}
	objReq.open("GET", ("http://localhost:8080/kickInTeam26/rest/materials"));
	objReq.send();
	var jsonObj = {
			items: {
			}
	}
	function addItem2(inum) {
		itemnum =jsonObj.items["item" + inum];
		inputvalue = document.getElementById("input" + inum).value
		inputvalue = Number(inputvalue);
		itemlist2 = document.getElementById("itemlist2");
		if (itemnum == null) {
			itemnum = inputvalue;
		} else {
			itemnum = itemnum + inputvalue;
		}
		
		jsonObj.items["item" + inum] = itemnum;
		htmltext = "";
		for (x in jsonObj.items) {
			htmltext += "<li>" + x + " : " + jsonObj.items[x] + "</li>";
			console.log(x);
			console.log(jsonObj.items[x]);
		}
		itemlist2.innerHTML = htmltext;
		console.log(jsonObj.items);
	}
	// let img = L.distortableImageOverlay('..\\resources\\testImages\\example.jpg', {
	//     actions: [L.RotateAction, L.DragAction, L.ScaleAction, L.DeleteAction]
	// }).addTo(map);
	// imgGroup.push(img);
	// img.on('remove', function() {
	//     const index = imgGroup.indexOf(img);
	//     if (index !== -1) {
	//         imgGroup.splice(index, 1);
	//     }
	// });
	// //function to enter free hand, if already in free hand, we exit free hand drawing.
	// function callEnterFreeHand() {
	// 	if (!inFreeHand) {
	// 		enterFreeDrawingMode();
	// 	} else {
	// 		exitFreeDraw();
	// 	}
	// }
	//
	// //enter free hand drawing.
	// function enterFreeDrawingMode() {
	// 	inFreeHand = true;
	// 	map.dragging.disable();
	// 	map.touchZoom.disable();
	// 	map.doubleClickZoom.disable();
	// 	map.scrollWheelZoom.disable();
	// 	map.boxZoom.disable();
	// 	map.keyboard.disable();
	// 	map.zoomControl.disable();
	// 	if (map.tap)
	// 		map.tap.disable();
	// 	document.getElementById('mapid').style.cursor = 'crosshair';
	// 	if (editToggle.state() === 'disable-editing') {
	// 		imgGroup.forEach(function(img) {
	// 			img.editing.disable();
	// 		});
	// 	}
	// 	editToggle.disable();
	//
	// 	let divContainer = document.createElement('div');
	// 	divContainer.setAttribute('id', 'freeDrawContainer');
	// 	// document.getElementsByClassName('leaflet-pane leaflet-overlay-pane')[0].appendChild(divContainer);
	// 	document.getElementById('mapContainer').appendChild(divContainer);
	// 	let dimensionData = document.getElementById('mapContainer');
	//
	// 	let stage = new Konva.Stage({
	// 		container : 'freeDrawContainer', // id of container <div>
	// 		width : dimensionData.offsetWidth,
	// 		height : dimensionData.offsetHeight,
	// 	});
	// 	let layer = new Konva.Layer();
	// 	let circle = new Konva.Circle({
	// 		x : (stage.width() / 2),
	// 		y : (stage.height() / 2),
	// 		radius : 70,
	// 		fill : 'red',
	// 		stroke : 'black',
	// 		strokeWidth : 4,
	// 		draggable : true,
	// 	});
	// 	layer.add(circle);
	// 	stage.add(layer);
	// 	layer.draw();
	// }
	//
	// //exit free hand drawing.
	// function exitFreeDraw() {
	// 	let data;
	// 	try {
	// 		data = trimCanvas(document.getElementsByTagName('canvas')[0]);
	// 	} catch (err) {
	// 		data = null;
	// 	}
	//
	// 	let needForAdd = true;
	// 	let canvas = null;
	// 	let imgFree = null;
	// 	let nw, ne, sw, se = null;
	//
	// 	if (data !== null && (data[2] === 0 || data[3] === 0)) {
	// 		needForAdd = false;
	// 	} else {
	// 		if (data !== null) {
	// 			nw = map.containerPointToLatLng([ data[0], data[1] ]);
	// 			ne = map.containerPointToLatLng([ data[0] + data[2], data[1] ]);
	// 			sw = map.containerPointToLatLng([ data[0], data[1] + data[3] ]);
	// 			se = map.containerPointToLatLng([ data[0] + data[2],
	// 					data[1] + data[3] ]);
	// 			canvas = data[4];
	// 			imgFree = canvas.toDataURL("image/png");
	// 		} else {
	// 			needForAdd = false;
	// 		}
	// 	}
	//
	// 	document.getElementById('freeDrawContainer').remove();
	// 	map.dragging.enable();
	// 	map.touchZoom.enable();
	// 	map.doubleClickZoom.enable();
	// 	map.scrollWheelZoom.enable();
	// 	map.boxZoom.enable();
	// 	map.keyboard.enable();
	// 	map.zoomControl.enable()
	// 	if (map.tap)
	// 		map.tap.enable();
	// 	document.getElementById('mapid').style.cursor = 'grab';
	//
	// 	if (editToggle.state() === 'disable-editing') {
	// 		imgGroup.forEach(function(img) {
	// 			img.editing.enable();
	// 		});
	// 	}
	// 	editToggle.enable();
	//
	// 	if (needForAdd) {
	// 		let freeDrawing = L.distortableImageOverlay(
	// 				imgFree,
	// 				{
	// 					corners : [ nw, ne, sw, se ],
	// 					actions : [ L.LockAction, L.UnlockAction,
	// 							L.OpacityAction, L.DeleteAction ],
	// 				}).addTo(map);
	// 		imgGroup.push(freeDrawing);
	// 		freeDrawing.on('remove', function() {
	// 			const index = imgGroup.indexOf(freeDrawing);
	// 			if (index !== -1) {
	// 				imgGroup.splice(index, 1);
	// 			}
	// 		});
	// 	}
	// 	inFreeHand = false;
	// }

	function addItem(resourceId) {
		let count = document.getElementById(resourceId.toString()).value;

		for (let i = 0; i < count; i++) {
			let img = L.distortableImageOverlay("data:image/png;utf-8;base64," + materialsList[resourceId].image, {
				actions: [L.RotateAction, L.DragAction, L.ScaleAction, L.DeleteAction]
			}).addTo(map);

			imgGroup.push(img);
			resourceArray.push(materialsList[resourceId]);

			const index = imgGroup.indexOf(img);
			img.on('remove', function() {

				if (index !== -1) {
					imgGroup.splice(index, 1);
					resourceArray.splice(index, 1);
				}
			});
		}
	}
	function save() {
		let save = new XMLHttpRequest();
		save.open("POST", "http://localhost:8080/kickInTeam26/rest/objects/")
		save.setRequestHeader("Content-Type", "application/json");
		save.send(constructSave())
	}

	function constructSave() {
		let string = "[";
		for (let i = 0; i < imgGroup.length; i++) {
			if (i !== 0) {
				string += ",";
			}
			string += '{ "mapid":"' + mapId + '", "resourceId":"' + resourceArray[i].resourceId + '", "latlangs":"' + '[' + imgGroup[i].getCorners() + ']" }';
		}
		string += "]";
		return string;
	}

	function retrieve() {
		let mapState = new XMLHttpRequest();
		mapState.open("GET", "http://localhost:8080/kickInTeam26/rest/objects/"+id);
	}

	//get the geoJSON data that can be used to reconstruct the map if needed.
	function getGeoJSON() {
		imgGroup.forEach(function(image) {
			console.log('{corners: [' + image.getCorners() + '], url: '
					+ image._url + '}');
		})
	}

	//for filtering materials depending on entered text
	function filterOn() {

	}
</script>
</html>