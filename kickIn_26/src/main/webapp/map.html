<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MapEdit</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="https://www.w3schools.com/w3css/4/w3.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>

    <!-- Material Design Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.18.0/css/mdb.min.css" rel="stylesheet">

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet"/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/vendor.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/vendor.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.css"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.js.map'></script>

    <link href="css/style.css" rel="stylesheet">
    <link href="css/mapEdit.css" rel="stylesheet">
    <link href="css/map.css" rel="stylesheet">

    <script src="js/requests.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/map.js"></script>

</head>

<style>


</style>

<body>

<!-- Top Nav -->
<div class="topnav">
    <a href="list.html" id="home"><i class="glyphicon glyphicon-home"></i></a>
    <a href="users.html" id="users"><i class="glyphicon glyphicon-user"></i></a>
    <a href="maps.html" id="maps"><i class="glyphicon glyphicon-globe"></i></a>
    <a href="resources.html" id="resources"><i class="glyphicon glyphicon-paperclip"></i></a>
    <a id="arrow" onclick="goBack()"><i class="glyphicon glyphicon-arrow-left"></i></a>
    <a id="logout" onclick="logout()">Logout</a>
</div>

<div id="content">

    <!-- Sidebar -->
    <div class="w3-sidebar w3-white w3-bar-block" style="width:25%">
        <h3 class="w3-bar-item">Menu</h3>
        <button class="w3-bar-item w3-button" onclick="addFenceToMap()">Add Fence</button>
        <button class="w3-bar-item w3-button" onclick="saveState()">Save Objects</button>
        <button class="w3-bar-item w3-button" onclick="openAccordion('availableItemsTab')">Available Items</button>
        <!--Available Items Tab-->
        <div class="w3-container w3-hide" id="availableItemsTab">
            <br>
            <!-- Search Bar-->
            <div class="md-form mt-0 col-md-8 active-green">
                <input aria-label="Search" class="form-control" id="searchItems"
                       onkeyup="searchTables('addItems','searchItems')"
                       placeholder="Search" type="text">
            </div>
            <!--List of Available Items Table-->
            <div class="col-md-11">
                <div id="itemlist"></div>
            </div>
        </div>


        <button class="w3-bar-item w3-button" onclick="openAccordion('addedItemsTab')">Added Items</button>


        <!--Added Items Tab-->
        <div class="w3-container w3-hide" id="addedItemsTab">
            <br>
            <div id="displayitems">Your list is currently empty.</div>
        </div>
    </div>


    <div id="mapContainer" style="margin-left:25%">
        <div id="mapid">
        </div>
    </div>
</div>

</body>
<script>
    function initMap() {
        let newMap = L.map('mapid', {
            center: [52.2413, -353.1531],
            zoom: 16,
            keyboard: false
        });
        let tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        tiles.addTo(newMap);
        return newMap;
    }

    function addFenceToMap() {
        addResourceToMap(23);
    }

    function massDelete(deleteObjectArray, callback) {
        let array = [];
        deleteObjectArray.forEach(function (object) {
            array.push(object.objectId);
        })
        if (array.length !== 0) {
            deleteObjects(array, mapId, function () {
                if (this.responseText) {
                    let response = JSON.parse(this.responseText);
                    console.log(response);
                }
                deletedObjects.clear();
                callback(true);
            })
        } else {
            callback(false);
        }
    }

    function massUpdate(callback) {
        let array = [];
        imgGroup.forEach(function (object) {
            let parsed = parseObject(object)
            if (parsed.latLangs !== mapObjects.get(object.objectId).latLangs) {
                let putObject = parsed;
                putObject.objectId = object.objectId;
                array.push(putObject);
            }
        })
        if (array.length !== 0) {
            updateObjects(array, mapId, function () {
                if (this.responseText) {
                    let response = JSON.parse(this.responseText);
                    console.log(response);
                }
                callback(true);
            })
        } else {
            callback(false);
        }
    }

    function massPost(callback) {
        let array = [];
        newObjects.forEach(function (object) {
            array.push(parseObject(object))
        });
        if (array.length !== 0) {
            addObjectsToMap(array, mapId, function () {
                if (this.responseText) {
                    let response = JSON.parse(this.responseText);
                    console.log(response);
                }
                callback(true);
            });
        } else {
            callback(false);
        }
    }

    function saveState() {
        massDelete(deletedObjects, function (deleteDone) {
            massUpdate(function (putDone) {
                massPost(function (postDone) {
                    bringAllObjectsForMap(mapId);
                });
            });
        });
    }

    function addResourceToMap(iid) {
        let woof = L.distortableImageOverlay(images.get(iid)).addTo(map);
        woof.on('remove', function () {
            const index = newObjects.indexOf(woof);
            if (index !== -1) {
                newObjects.splice(index, 1);
            }
        });
        woof.resourceId = iid;
        newObjects.push(woof);
    }

    function bringAllResources() {
        getAllResources(function () {
            let response = JSON.parse(this.responseText);
            response.forEach(function (resource) {
                images.set(resource.resourceId, resource.image);
                resources.set(resource.resourceId, resource.name)
            })
            bringAllObjectsForMap(mapId);
        })
    }

    function clearMap() {
        deletedObjects.clear();
        mapObjects.clear();
        const lengthImgGroup = imgGroup.length;
        const newObjectsLength = newObjects.length;
        for (let i = 0; i < lengthImgGroup; i++) {
            imgGroup[0].editing._overlay.remove();
        }

        for (let i = 0; i < newObjectsLength; i++) {
            newObjects[0].editing._overlay.remove();
        }
        imgGroup = [];
        newObjects = [];
    }

    function disableEditingForAll() {
        imgGroup.forEach(function (img) {
            img.editing.enable();
        });
    }

    function enableEditingForAll() {
        imgGroup.forEach(function (img) {
            img.editing.disable();
        });
    }

    function bringAllObjectsForMap(mapId) {
        disableEditingForAll();
        getAllObjectsForMap(mapId, function () {
            let response = JSON.parse(this.responseText);
            clearMap();
            deletedObjects.clear();
            mapObjects = new Map();
            response.forEach(function (object) {
                mapObjects.set(object.objectId, object)
            })
            insertObjectsToMap();
            enableEditingForAll();
        })
    }

    function parseObject(newObject) {
        return {
            mapId: mapId,
            resourceId: newObject.resourceId,
            latLangs: JSON.stringify(newObject.getCorners())
        };
    }

    function insertObjectsToMap() {
        mapObjects.forEach(insertObjectIntoMap)
    }

    function parseLatLangs(stringyLatLangs) {
        let latLangArray = JSON.parse(stringyLatLangs);
        let coords = [];
        latLangArray.forEach(function (point) {
            coords.push(L.latLng(point.lat, point.lng))
        })
        return coords;
    }

    function pushToMap(newImage, object) {
        newImage.on('remove', function () {
            deletedObjects.add(object);
            mapObjects.delete(newImage.objectId);
            const index = imgGroup.indexOf(newImage);
            if (index !== -1) {
                imgGroup.splice(index, 1);
            }
        });
        imgGroup.push(newImage);
        newImage.addTo(map);
    }

    function insertObjectIntoMap(object) {
        let corners = parseLatLangs(object.latLangs);
        let newImage = L.distortableImageOverlay(images.get(object.resourceId), {
            corners: corners
        })
        newImage.objectId = object.objectId;
        newImage.resourceId = object.resourceId;
        pushToMap(newImage, object);
    }

    let map = initMap();
    let mapId = 1;
    //all available resources
    let resources = new Map();
    //their images
    let images = new Map();
    //stuff on the map
    let mapObjects = new Map();
    //the image group for the library
    let imgGroup = [];
    //new objects added to the map.
    let newObjects = [];
    let deletedObjects = new Set();

    bringAllResources();

</script>
</html>