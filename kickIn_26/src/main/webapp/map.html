<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MapEdit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/vendor.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/vendor.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.16.6/dist/leaflet.distortableimage.js.map'></script>

    <link rel="stylesheet" href="css/mapEdit.css">
    <script src="js/requests.js"></script>
    <script src="js/utils.js"></script>

</head>
<body>

<!-- Sidebar -->
<div class="w3-sidebar w3-white w3-bar-block" style="width:20%">
    <h3 class="w3-bar-item">Menu</h3>
    <button class="w3-bar-item w3-button" onclick="addFenceToMap()">Add Fence</button>
    <button class="w3-bar-item w3-button" onclick="saveState()">Save Objects</button>
</div>

<div id="mapContainer" style="margin-left:20%">
    <div id="mapid"></div>
</div>
</body>
<script>
    function initMap() {
        let newMap = L.map('mapid', {
            center: [52.2413, -353.1531],
            zoom: 16,
            keyboard: false
        });
        let tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        tiles.addTo(newMap);
        return newMap;
    }
    function addFenceToMap() {
        addResourceToMap(23);
    }
    function massDelete(deleteObjectArray, callback) {
        let array = [];
        deleteObjectArray.forEach(function (object) {
            array.push(object.objectId);
        })
        if (array.length !== 0) {
            deleteObjects(array, mapId, function() {
                if (this.responseText) {
                    let response = JSON.parse(this.responseText);
                    console.log(response);
                }
                deletedObjects.clear();
                callback(true);
            })
        } else {
            callback(false);
        }
    }
    function massUpdate(callback) {
        let array = [];
        imgGroup.forEach(function (object) {
            let parsed = parseObject(object)
            if (parsed.latLangs !== mapObjects.get(object.objectId).latLangs) {
                let putObject = parsed;
                putObject.objectId = object.objectId;
                array.push(putObject);
            }
        })
        if (array.length !== 0) {
            updateObjects(array, mapId, function() {
                if (this.responseText) {
                    let response = JSON.parse(this.responseText);
                    console.log(response);
                }
                callback(true);
            })
        } else {
            callback(false);
        }
    }
    function massPost(callback) {
        let array = [];
        newObjects.forEach(function (object) {
            array.push(parseObject(object))
        });
        if (array.length !== 0) {
            addObjectsToMap(array, mapId, function () {
                if (this.responseText) {
                    let response = JSON.parse(this.responseText);
                    console.log(response);
                }
                callback(true);
            });
        } else {
            callback(false);
        }
    }
    function saveState() {
        massDelete(deletedObjects, function (deleteDone) {
            massUpdate(function (putDone) {
                massPost(function (postDone) {
                    bringAllObjectsForMap(mapId);
                });
            });
        });
    }
    function addResourceToMap(iid) {
        let woof = L.distortableImageOverlay(images.get(iid)).addTo(map);
        woof.on('remove', function() {
            const index = newObjects.indexOf(woof);
            if (index !== -1) {
                newObjects.splice(index, 1);
            }
        });
        woof.resourceId = iid;
        newObjects.push(woof);
    }
    function bringAllResources() {
        getAllResources(function() {
            let response = JSON.parse(this.responseText);
            response.forEach(function(resource) {
                images.set(resource.resourceId, resource.image);
                resources.set(resource.resourceId, resource.name)
            })
            bringAllObjectsForMap(mapId);
        })
    }
    function clearMap() {
        deletedObjects.clear();
        mapObjects.clear();
        const lengthImgGroup = imgGroup.length;
        const newObjectsLength = newObjects.length;
        for (let i = 0; i < lengthImgGroup; i++) {
            imgGroup[0].editing._overlay.remove();
        }

        for (let i = 0; i < newObjectsLength; i++) {
            newObjects[0].editing._overlay.remove();
        }
        imgGroup = [];
        newObjects = [];
    }
    function disableEditingForAll() {
        imgGroup.forEach(function (img) {
            img.editing.enable();
        });
    }
    function enableEditingForAll() {
        imgGroup.forEach(function (img) {
            img.editing.disable();
        });
    }
    function bringAllObjectsForMap(mapId) {
        disableEditingForAll();
        getAllObjectsForMap(mapId, function() {
            let response = JSON.parse(this.responseText);
            clearMap();
            deletedObjects.clear();
            mapObjects = new Map();
            response.forEach(function (object) {
                mapObjects.set(object.objectId, object)
            })
            insertObjectsToMap();
            enableEditingForAll();
        })
    }
    function parseObject(newObject) {
        return {
            mapId:mapId,
            resourceId:newObject.resourceId,
            latLangs:JSON.stringify(newObject.getCorners())
        };
    }
    function insertObjectsToMap() {
        mapObjects.forEach(insertObjectIntoMap)
    }
    function parseLatLangs(stringyLatLangs) {
        let latLangArray = JSON.parse(stringyLatLangs);
        let coords = [];
        latLangArray.forEach(function (point) {
            coords.push(L.latLng(point.lat, point.lng))
        })
        return coords;
    }
    function pushToMap(newImage, object) {
        newImage.on('remove', function () {
            deletedObjects.add(object);
            mapObjects.delete(newImage.objectId);
            const index = imgGroup.indexOf(newImage);
            if (index !== -1) {
                imgGroup.splice(index, 1);
            }
        });
        imgGroup.push(newImage);
        newImage.addTo(map);
    }
    function insertObjectIntoMap(object) {
        let corners = parseLatLangs(object.latLangs);
        let newImage = L.distortableImageOverlay(images.get(object.resourceId), {
            corners: corners
        })
        newImage.objectId = object.objectId;
        newImage.resourceId = object.resourceId;
        pushToMap(newImage, object);
    }

    let map = initMap();
    let mapId = 1;
    //all available resources
    let resources = new Map();
    //their images
    let images = new Map();
    //stuff on the map
    let mapObjects = new Map();
    //the image group for the library
    let imgGroup = [];
    //new objects added to the map.
    let newObjects = [];
    let deletedObjects = new Set();

    bringAllResources();

</script>
</html>